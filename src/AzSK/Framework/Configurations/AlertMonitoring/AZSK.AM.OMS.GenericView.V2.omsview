{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "omsWorkspaceLocation": {
      "type": "string",
      "defaultValue": ""
    },
    "omsResourcegroup": {
      "type": "string",
      "defaultValue": ""
    },
    "omsSubscriptionId": {
      "type": "string",
      "defaultValue": ""
    },
    "omsWorkspaceName": {
      "type": "string",
      "defaultValue": ""
    },
    "omsWorkspaceApiVersion": {
      "type": "string",
      "defaultValue": "2015-11-01-preview"
    },
    "viewName": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {
    "ViewName": "[concat('AzSK Security View - ', parameters('viewName'))]"
  },
  "resources": [
    {
      "apiVersion": "[parameters('omsWorkspaceApiVersion')]",
      "name": "[parameters('omsWorkspaceName')]",
      "type": "Microsoft.OperationalInsights/workspaces",
      "location": "[parameters('omsWorkspaceLocation')]",
      "id": "[Concat('/subscriptions/', parameters('omsSubscriptionId'), '/resourceGroups/', parameters('omsResourcegroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]",
      "resources": [
        {
          "apiVersion": "2015-11-01-preview",
          "name": "[variables('ViewName')]",
          "type": "views",
          "location": "[parameters('omsWorkspaceLocation')]",
          "id": "[Concat('/subscriptions/', parameters('omsSubscriptionId'), '/resourceGroups/', parameters('omsResourcegroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'),'/views/',variables('ViewName'))]",
          "dependson": [
            "[Concat('/subscriptions/', parameters('omsSubscriptionId'), '/resourceGroups/', parameters('omsResourcegroup'), '/providers/Microsoft.OperationalInsights/workspaces/', parameters('omsWorkspaceName'))]"
          ],
          "properties": {
            "DisplayName": "[variables('ViewName')]",
            "Id": "[variables('ViewName')]",
            "Name": "[variables('ViewName')]",
            "Author": "Microsoft",
            "Source": "Local",
            "Version": 2,
            "Dashboard": [
              {
                "Id": "InformationBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "Title": "About the AzSK Security Monitoring View",
                    "NewGroup": false,
                    "Color": "#0072c6"
                  },
                  "Header": {
                    "Image": "data:image/png;base64,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",
                    "Label": "Security Monitoring using the AzSK",
                    "Link": {
                      "Label": "More info",
                      "Url": " https://github.com/azsk/DevOpsKit-docs/tree/master/05-Alerting-and-Monitoring "
                    }
                  },
                  "List": [
                    {
                      "Title": "How to use this view...",
                      "Content": "This view contains multiple blades. Each blade represents a 'view' of the security status of your cloud assets along a speicfic dimension (or a specific pivot).\n\nEach blade contains a graphic on the top followed by a list underneath. The graphic presents a pictorial gist. \n\nYou can click on the list below the graphic for any blade to look at the detailed control failure data (control evaluation events as they were received by Log Analytics workspace from AzSK scans). These events contain useful information (such as 'Recommendation') that you can leverage to fix issues.\n\nAny blade depicts baseline control events received by Log Analytics workspace for last scan done within  last 3 days. Typically these would be events generated via Continuous Assurance (CA) scanning. However, manual scan results can also come here if AzSK is configured to forward local scan events to Log Analytics. \n\nIt is important to understand that, per the current plan, CA scanning will be turned on for various resource types/controls in waves. At any stage, this view will only show the baseline controls which have been (centrally) enabled for CA scanning. This is to improve our security posture in multiple 'waves'. If you would like to determine and fix controls beyond the ones currently enabled, you can manually run the scan commands and look at the CSV (or this view if you have local OMS forwarding enabled in AzSK).\n\nIf multiple subscriptions have been configured to use this Log Analytics workspace then the view aggregates data from all subscriptions. (You can use/apply filters to view the data for a specific subscription.)\n\nNote that, although it should serve the needs of a lot of scenarios, this is *still* just a sample view. There are lots of possible ways other views can be generated by you (or you can integrate one or more blades from this view into your own views).\n\nThere are 7 blades in this view.\n\n1. **Subscription Security (SS)**\nThis shows the overall status of subscription-related baseline security controls for your subscription. Control failures in this area will typically need subscription owner privilege to fix.\n\n2. **ExpressRoute vNet Security (ER)**\nThis shows baseline security control status for virtual networks in your subscription that have Express Route connectivity setup. These are shown separately because any control failures in this area subject the corporate network to risks.\nControls in this area should be fixed by someone with network/infra knowledge. \n\n3. **Resource Security (RS-1)**\nThis shows the overall status of baseline control failures for cloud resources (excluding subscription controls). The table shows # of failures by resource type. \nThis can help you gauge the overall remediation work that is needed for your cloud resources.\nThe table will also help you understand which resource types are most vulnerable in your subscription. \n\n4. **Resource Security (RS-2)**\nThis shows the number of unique resource types that have at least one baseline security control failure followed by a list of resources with most # of failures. \nThis can be used to determine which resources to target first to get the aggregate count down fast.\n\n5. **Resource Security (RS-3)**\nThis shows a view of failing resources pivoted by resource group. The number of unique resource group that contain failing resources is shown at the top...followed by a table of resource groups ordered by number of baseline control failures attributable to each resource group.\nAs resources are likely grouped logically by services/applications, this view can help with distributing/allocating remediation work to respective service owners.\n\n6. **Resource Security (RS-4)**\nThis view tells you how many different unique baseline security controls  are failing and lists them by number of failures for each control type. \nThis can help you assess how many 'unique' investigations you will have to perform to remediate all failures. (Typically, the work done to fix a specific controlId for a resource will be reusable when fixing the *same* control for another resource.)\n\n7. **Useful Queries** \nIn this last blade, we have also included a small bundle of queries that you can use as is or tweak to create your own custom queries.\nThese can be used as a starting point for setting up your own alerts, doing auto-heal, etc.\n\nYou can get other useful queries for the Monitoring solution from our Github documentation at: https://aka.ms/devopskit/omsqueries\n\nPlease contact AzSK support if you need further help using this view. \n\nHappy Security Monitoring!"
                    }
                  ]
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Subscription Security (SS)",
                    "newGroup": true,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Subscription Security Status",
                    "Subtitle": "AzSK Subscription Compliance"
                  },
                  "Donut": {
                    "Query": "AzSK_CL | where TimeGenerated > ago(3d)  | summarize arg_max(TimeGenerated, *) by SubscriptionId,ControlId_s | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s == \"SubscriptionCore\"  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\") | summarize  count() by SubscriptionId,ControlId_s,ControlStatus | summarize AggregatedValue = count() by ControlStatus | sort by AggregatedValue desc",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": [ ]
                    },
                    "Options": {
                      "colors": [
                        "#e81123",
                        "#007233",
                        "#fff100"
                      ],
                      "valueColorMapping": [
                        {
                          "value": "Passed",
                          "color": "#007233"
                        },
                        {
                          "value": "RiskAck",
                          "color": "#fcd116"
                        },
                        {
                          "value": "Verify",
                          "color": "#ff8c00"
                        },
                        {
                          "value": "Failed",
                          "color": "#ba141a"
                        }
                      ]
                    },
                    "NavigationSelect": { }
                  },
                  "List": {
                    "Query": "AzSK_CL | where TimeGenerated > ago(3d)  | summarize arg_max(TimeGenerated, *) by SubscriptionName_s,ControlId_s | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s == \"SubscriptionCore\"  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\") | where ControlStatus==\"Failed\"| summarize  count() by SubscriptionName_s,ControlId_s,ControlStatus_s | summarize AggregatedValue = count() by SubscriptionName_s | sort by AggregatedValue desc",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Subscription ID",
                      "Value": "# of Failures"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)   | summarize arg_max(TimeGenerated, *) by SubscriptionName_s,ControlId_s  | where HasRequiredAccess_b == true and IsBaselineControl_b == true   | where FeatureName_s == \"SubscriptionCore\"  and  {selected item} | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\")| where ControlStatus==\"Failed\"",
                    "NavigationSelect": {
                      "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)   | summarize arg_max(TimeGenerated, *) by SubscriptionName_s,ControlId_s  | where HasRequiredAccess_b == true and IsBaselineControl_b == true   | where FeatureName_s == \"SubscriptionCore\"  and  {selected item} | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\")| where ControlStatus==\"Failed\""
                    }
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "ExpressRoute VNet Security (ER)",
                    "newGroup": true,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Express Route Network Security",
                    "Subtitle": "AzSK ER Security Compliance"
                  },
                  "Donut": {
                    "Query": "AzSK_CL | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true | where FeatureName_s == \"ERvNet\"  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\")   | summarize arg_max(TimeGenerated,*) by  SubscriptionName_s,ResourceId,ControlId_s | summarize AggregatedValue = count() by ControlStatus | sort by AggregatedValue desc",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": [ ]
                    },
                    "Options": {
                      "colors": [
                        "#00188f",
                        "#0072c6",
                        "#00bcf2"
                      ],
                      "valueColorMapping": [
                        {
                          "value": "Passed",
                          "color": "#007233"
                        },
                        {
                          "value": "Failed",
                          "color": "#ba141a"
                        },
                        {
                          "value": "RiskAck",
                          "color": "#ff8c00"
                        },
                        {
                          "value": "Verify",
                          "color": "#fff100"
                        }
                      ]
                    },
                    "NavigationSelect": { }
                  },
                  "List": {
                    "Query": "AzSK_CL | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true | where FeatureName_s == \"ERvNet\"  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\")   | summarize arg_max(TimeGenerated,*) by  SubscriptionName_s,ResourceId,ControlId_s | where ControlStatus ==\"Failed\" | summarize AggregatedValue = count() by SubscriptionName_s | sort by AggregatedValue desc",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Severity Of Failed Controls",
                      "Value": "# Of Failures"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)    | where HasRequiredAccess_b == true and IsBaselineControl_b == true   | where FeatureName_s == \"ERvNet\" and {selected item}  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\") | where ControlStatus ==\"Failed\"    | summarize arg_max(TimeGenerated,*) by  SubscriptionName_s,ResourceId,ControlId_s",
                    "NavigationSelect": {
                      "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)    | where HasRequiredAccess_b == true and IsBaselineControl_b == true   | where FeatureName_s == \"ERvNet\" and {selected item}  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\")  | where ControlStatus ==\"Failed\"   | summarize arg_max(TimeGenerated,*) by  SubscriptionName_s,ResourceId,ControlId_s"
                    }
                  }
                }
              },
              {
                "Id": "SingleQueryDonutBuilderBladeV1",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Resource Security (RS-1)",
                    "newGroup": true,
                    "icon": "",
                    "useIcon": false
                  },
                  "Header": {
                    "Title": "Security Status across Resources",
                    "Subtitle": "AzSK Resource Security Compliance "
                  },
                  "Donut": {
                    "Query": "AzSK_CL | where TimeGenerated > ago(3d) | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"  | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | summarize AggregatedValue = count() by ControlStatus | sort by AggregatedValue desc",
                    "CenterLegend": {
                      "Text": "Total",
                      "Operation": "Sum",
                      "ArcsToSelect": [ ]
                    },
                    "Options": {
                      "colors": [
                        "#e81123",
                        "#007233",
                        "#fff100"
                      ],
                      "valueColorMapping": [
                        {
                          "value": "Passed",
                          "color": "#007233"
                        },
                        {
                          "value": "RiskAck",
                          "color": "#fff100"
                        },
                        {
                          "value": "Verify",
                          "color": "#ff8c00"
                        },
                        {
                          "value": "Failed",
                          "color": "#ba141a"
                        }
                      ]
                    },
                    "NavigationSelect": { }
                  },
                  "List": {
                    "Query": "AzSK_CL  | where TimeGenerated > ago(3d) | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"  | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" | summarize AggregatedValue = count() by FeatureName_s | sort by AggregatedValue desc",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "ResourceType Names",
                      "Value": "# Of Failures"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d) | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where {selected item} | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" ",
                    "NavigationSelect": {
                      "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d) | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where {selected item} | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" "
                    }
                  }
                }
              },
              {
                "Id": "NumberTileListBuilderBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Resource Security (RS-2)",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Tile": {
                    "Query": "AzSK_CL  | where TimeGenerated >ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"  | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ResourceName_s  | count ",
                    "Legend": "Unique Resources with Security Issues",
                    "NavigationSelect": { }
                  },
                  "List": {
                    "Query": "AzSK_CL  | where TimeGenerated >ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"  | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ResourceName_s ",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "Resource Names",
                      "Value": "# Of Failures"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "AzSK_CL  | where TimeGenerated >ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\" and {selected item} | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" ",
                    "NavigationSelect": {
                      "NavigationQuery": "AzSK_CL  | where TimeGenerated >ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\" and {selected item} | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" "
                    }
                  }
                }
              },
              {
                "Id": "NumberTileListBuilderBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Resource Security (RS-3)",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Tile": {
                    "Query": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"   | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ResourceGroup | count",
                    "Legend": "Unique ResourceGroups with Security Issues",
                    "NavigationSelect": { }
                  },
                  "List": {
                    "Query": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"   | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ResourceGroup",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "ResourceGroup Names",
                      "Value": "# Of Failures"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"   and {selected item}| extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" ",
                    "NavigationSelect": {
                      "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"   and {selected item}| extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" "
                    }
                  }
                }
              },
              {
                "Id": "NumberTileListBuilderBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Resource Security (RS-4)",
                    "newGroup": false,
                    "icon": "",
                    "useIcon": false
                  },
                  "Tile": {
                    "Query": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"   | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ControlId_s | count ",
                    "Legend": "Unique security failures across all resources",
                    "NavigationSelect": { }
                  },
                  "List": {
                    "Query": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"   | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ControlId_s",
                    "HideGraph": false,
                    "enableSparklines": false,
                    "operation": "Summary",
                    "ColumnsTitle": {
                      "Name": "ControlId Names",
                      "Value": "# Of Failures"
                    },
                    "Color": "#ba141a",
                    "thresholds": {
                      "isEnabled": false,
                      "values": [
                        {
                          "name": "Normal",
                          "threshold": "Default",
                          "color": "#009e49",
                          "isDefault": true
                        },
                        {
                          "name": "Warning",
                          "threshold": "60",
                          "color": "#fcd116",
                          "isDefault": false
                        },
                        {
                          "name": "Error",
                          "threshold": "90",
                          "color": "#ba141a",
                          "isDefault": false
                        }
                      ]
                    },
                    "NameDSVSeparator": "",
                    "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"  and {selected item} | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" ",
                    "NavigationSelect": {
                      "NavigationQuery": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true and IsBaselineControl_b == true  | where FeatureName_s != \"SubscriptionCore\"  and {selected item} | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" "
                    }
                  }
                }
              },
              {
                "Id": "NotableQueriesBuilderBlade",
                "Type": "Blade",
                "Version": 0,
                "Configuration": {
                  "General": {
                    "title": "Useful Queries",
                    "newGroup": false,
                    "preselectedFilters": "SubscriptionName_s, ResourceGroup , ResourceName_s , FeatureName_s , ControlId_s, ControlSeverity_s , ControlStatus_s",
                    "renderMode": "grid"
                  },
                  "queries": [
                    {
                      "query": "AzSK_CL | where TimeGenerated > ago(3d)  | summarize arg_max(TimeGenerated, *) by SubscriptionName_s,ControlId_s | where HasRequiredAccess_b == true  | where FeatureName_s == \"SubscriptionCore\"  | extend ControlStatus=iff(ControlStatus_s!= \"Passed\",\"Failed\",\"Passed\") | summarize  count() by SubscriptionName_s,ControlId_s,ControlStatus_s | summarize AggregatedValue = count() by SubscriptionName_s | sort by AggregatedValue desc",
                      "displayName": "Distribution By ControlStatus for last scan done with required access including NonBaseline controls"
                    },
                    {
                      "query": "AzSK_CL  | where TimeGenerated >ago(3d)  | where HasRequiredAccess_b == true  | where FeatureName_s != \"SubscriptionCore\"  | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by FeatureName_s",
                      "displayName": "Distribution of Failed Controls by Resource Type for last scan done with required access including NonBaseline controls"
                    },
                    {
                      "query": "AzSK_CL  | where TimeGenerated >ago(3d)  | where HasRequiredAccess_b == true  | where FeatureName_s != \"SubscriptionCore\"  | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ResourceName_s ",
                      "displayName": "Distribution of Failed Controls by Resource Name for last scan done with required access including NonBaseline controls"
                    },
                    {
                      "query": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true | where FeatureName_s != \"SubscriptionCore\"   | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ControlId_s",
                      "displayName": "Distribution of Failed Controls by ControlIds for last scan done with required access including NonBaseline controls"
                    },
                    {
                      "query": "AzSK_CL | where TimeGenerated > ago(3d) | where HasRequiredAccess_b == true | where FeatureName_s == \"SubscriptionCore\" | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\") | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s | where ControlStatus == \"Failed\" | summarize  AggregatedValue = count() by ControlId_s",
                      "displayName": "Distribution of Failed Subscription Controls for last scan done with required access including NonBaseline controls"
                    },
                    {
                      "query": "AzSK_CL  | where TimeGenerated > ago(3d)  | where HasRequiredAccess_b == true | where FeatureName_s != \"SubscriptionCore\"   | summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s  | summarize  AggregatedValue = count() by ControlId_s,ControlStatus_s",
                      "displayName": "Distribution By ControlIDs for last scan done with required access including NonBaseline controls"
                    }
                  ]
                }
              }
            ],
            "Filters": [ ],
            "OverviewTile": {
              "Id": "SingleQueryDonutBuilderTileV1",
              "Type": "OverviewTile",
              "Version": 2,
              "Configuration": {
                "Donut": {
                  "Query": "AzSK_CL| where TimeGenerated > ago(3d)| where HasRequiredAccess_b == true and IsBaselineControl_b == true | extend ControlStatus = iff(ControlStatus_s == \"Passed\", \"Passed\",\"Failed\")| summarize arg_max(TimeGenerated, *) by SubscriptionId, ResourceId, ControlId_s| where ControlStatus == \"Failed\"| summarize AggregatedValue = count() by FeatureName_s| sort by AggregatedValue desc",
                  "CenterLegend": {
                    "Text": "Total",
                    "Operation": "Sum",
                    "ArcsToSelect": [ ]
                  },
                  "Options": {
                    "colors": [
                      "#ba141a",
                      "#eb3c00",
                      "#ff8c00"
                    ],
                    "valueColorMapping": [ ],
                    "legend": true,
                    "skipLegendPositioning": true,
                    "center": true,
                    "unitType": "Count",
                    "fromUnit": "Ones"
                  },
                  "HideOtherLegend": true
                },
                "Advanced": {
                  "DataFlowVerification": {
                    "Enabled": false,
                    "Query": "search * | limit 1 | project TimeGenerated",
                    "Message": ""
                  }
                }
              }
            }
          }
        }
      ]
    }
  ]
}
